app-id: net.fhannenheim.musicfetch
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: com.system76.Cosmic.BaseApp
base-version: stable
command: musicfetch_gui

finish-args:
  # Wayland access
  - --socket=wayland
  # X11 Fallback
  - --share=ipc
  - --socket=fallback-x11
  # Network for downloads
  - --share=network
  # Home directory access for saving photos/videos
  - --filesystem=xdg-music:rw
  # flathub-linter: skip=finish-args-unnecessary-xdg-config-cosmic-rw-access
  - --filesystem=xdg-config/cosmic:rw
  # D-Bus access for COSMIC config daemon (live theme/config updates)
  # The wildcard is needed because the settings daemon creates dynamic config proxy
  # names like com.system76.CosmicSettingsDaemon.Config.com.system76.CosmicTheme.Dark.V1
  - --talk-name=com.system76.CosmicSettingsDaemon
  - --talk-name=com.system76.CosmicSettingsDaemon.*
  # Needed to open the directory the songs are downloaded to
  # xdg portal can only open the top-level dir in the document portal
  - --talk-name=org.freedesktop.FileManager1

modules:
  - name: deno
    buildsystem: simple
    build-commands:
      - install -Dt /app/bin deno
    sources:
      - type: archive
        url: >-
          https://github.com/denoland/deno/releases/download/v2.6.10/deno-x86_64-unknown-linux-gnu.zip
        sha256: a7c9d5c1f93bfaabe03c3c0583a8c88caf695db3cec4dea2938440038609f225
        x-checker-data:
          type: json
          url: https://api.github.com/repos/denoland/deno/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | select(.name ==
            "deno-x86_64-unknown-linux-gnu.zip").browser_download_url
        only-arches:
          - x86_64
      - type: archive
        url: >-
          https://github.com/denoland/deno/releases/download/v2.6.10/deno-aarch64-unknown-linux-gnu.zip
        sha256: ad4031b16b193997cd40d2bf68c9af8b5148e0f39c1e975cfbb6d60ecec19496
        x-checker-data:
          type: json
          url: https://api.github.com/repos/denoland/deno/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | select(.name ==
            "deno-aarch64-unknown-linux-gnu.zip").browser_download_url
        only-arches:
          - aarch64
  - name: yt-dlp-ejs
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app *.whl
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/a4/90/8911146822364666be47f184c4180cec20fcc537a268ef40d1ab077dd25b/yt_dlp_ejs-0.4.0-py3-none-any.whl
        sha256: 19278cff397b243074df46342bb7616c404296aeaff01986b62b4e21823b0b9c
        x-checker-data:
          type: pypi
          name: yt-dlp-ejs
          packagetype: bdist_wheel
  - name: yt-dlp
    buildsystem: simple
    build-commands:
      - pip3 install --no-dependencies --prefix=/app *.whl
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/96/38/b17cbeaf6712a4c1b97f7f9ec3a55f3a8ddee678cc88742af47dca0315b7/yt_dlp-2026.2.4-py3-none-any.whl
        sha256: d6ea83257e8127a0097b1d37ee36201f99a292067e4616b2e5d51ab153b3dbb9
        x-checker-data:
          type: pypi
          name: yt-dlp
          packagetype: bdist_wheel
  - name: musicfetch
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/musicfetch/cargo
        CARGO_TARGET_DIR: /run/build/musicfetch/target
    build-commands:
      # Build the application with cargo (version is passed via .flatpak-version file)
      - |
        cargo --offline fetch --manifest-path Cargo.toml --verbose
        cargo --offline build --release --verbose
      # Install the binary
      - install -Dm755 target/release/musicfetch_gui -t /app/bin/
      # Install desktop file
      - install -Dm644 resources/net.fhannenheim.musicfetch.desktop -t /app/share/applications/
      # Install icon
      - install -Dm644 resources/icons/hicolor/scalable/apps/net.fhannenheim.musicfetch.svg
        -t /app/share/icons/hicolor/scalable/apps/
      # Install metainfo
      - install -Dm644 resources/net.fhannenheim.musicfetch.metainfo.xml -t /app/share/metainfo/
    sources:
      - type: git
        url: https://codeberg.org/Frieder_Hannenheim/musicfetch-ng.git
        tag: 1.4.0
        commit: 6de1d0a826c2dd9deef61a97711814befdd1f776
      - cargo-sources.json
