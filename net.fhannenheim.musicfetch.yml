app-id: net.fhannenheim.musicfetch
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: com.system76.Cosmic.BaseApp
base-version: stable
command: musicfetch_gui

finish-args:
  # Wayland access
  - --socket=wayland
  # X11 Fallback
  - --share=ipc
  - --socket=fallback-x11
  # Network for downloads
  - --share=network
  # Home directory access for saving photos/videos
  - --filesystem=xdg-music:rw
  # flathub-linter: skip=finish-args-unnecessary-xdg-config-cosmic-rw-access
  - --filesystem=xdg-config/cosmic:rw
  # D-Bus access for COSMIC config daemon (live theme/config updates)
  # The wildcard is needed because the settings daemon creates dynamic config proxy
  # names like com.system76.CosmicSettingsDaemon.Config.com.system76.CosmicTheme.Dark.V1
  - --talk-name=com.system76.CosmicSettingsDaemon
  - --talk-name=com.system76.CosmicSettingsDaemon.*
  # Needed to open the directory the songs are downloaded to
  # xdg portal can only open the top-level dir in the document portal
  - --talk-name=org.freedesktop.FileManager1

modules:
  - name: deno
    buildsystem: simple
    build-commands:
      - install -Dt /app/bin deno
    sources:
      - type: archive
        url: >-
          https://github.com/denoland/deno/releases/download/v2.7.0/deno-x86_64-unknown-linux-gnu.zip
        sha256: f1ca687ba8545105ba5809688ef659d96fe4272acc11e8b4800657cdb0045b7d
        x-checker-data:
          type: json
          url: https://api.github.com/repos/denoland/deno/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | select(.name ==
            "deno-x86_64-unknown-linux-gnu.zip").browser_download_url
        only-arches:
          - x86_64
      - type: archive
        url: >-
          https://github.com/denoland/deno/releases/download/v2.7.0/deno-aarch64-unknown-linux-gnu.zip
        sha256: 04d35f9f836c92804dcfb433740e0c6dbdea2b32b444a50dc71aa03dcaf06589
        x-checker-data:
          type: json
          url: https://api.github.com/repos/denoland/deno/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | select(.name ==
            "deno-aarch64-unknown-linux-gnu.zip").browser_download_url
        only-arches:
          - aarch64
  - name: yt-dlp-ejs
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app *.whl
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/7e/5b/1283356b70d4893a8a050cee15092e1b08ea15310b94365f88067146721b/yt_dlp_ejs-0.5.0-py3-none-any.whl
        sha256: 674fc0efea741d3100cdf3f0f9e123150715ee41edf47ea7a62fbdeda204bdec
        x-checker-data:
          type: pypi
          name: yt-dlp-ejs
          packagetype: bdist_wheel
  - name: yt-dlp
    buildsystem: simple
    build-commands:
      - pip3 install --no-dependencies --prefix=/app *.whl
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/5a/40/664c99ee36d80d84ce7a96cd98aebcb3d16c19e6c3ad3461d2cf5424040e/yt_dlp-2026.2.21-py3-none-any.whl
        sha256: 0d8408f5b6d20487f5caeb946dfd04f9bcd2f1a3a125b744a0a982b590e449f7
        x-checker-data:
          type: pypi
          name: yt-dlp
          packagetype: bdist_wheel
  - name: musicfetch
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/musicfetch/cargo
        CARGO_TARGET_DIR: /run/build/musicfetch/target
    build-commands:
      # Build the application with cargo (version is passed via .flatpak-version file)
      - |
        cargo --offline fetch --manifest-path Cargo.toml --verbose
        cargo --offline build --release --verbose
      # Install the binary
      - install -Dm755 target/release/musicfetch_gui -t /app/bin/
      # Install desktop file
      - install -Dm644 resources/net.fhannenheim.musicfetch.desktop -t /app/share/applications/
      # Install icon
      - install -Dm644 resources/icons/hicolor/scalable/apps/net.fhannenheim.musicfetch.svg
        -t /app/share/icons/hicolor/scalable/apps/
      # Install metainfo
      - install -Dm644 resources/net.fhannenheim.musicfetch.metainfo.xml -t /app/share/metainfo/
    sources:
      - type: git
        url: https://codeberg.org/Frieder_Hannenheim/musicfetch-ng.git
        tag: 1.4.0
        commit: 6de1d0a826c2dd9deef61a97711814befdd1f776
      - cargo-sources.json
