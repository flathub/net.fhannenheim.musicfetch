app-id: net.fhannenheim.musicfetch
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
base: com.system76.Cosmic.BaseApp
base-version: stable
command: musicfetch_gui

finish-args:
  # Wayland access
  - --socket=wayland
  # X11 Fallback
  - --share=ipc
  - --socket=fallback-x11
  # Network for downloads
  - --share=network
  # Home directory access for saving photos/videos
  - --filesystem=xdg-music:rw
  # flathub-linter: skip=finish-args-unnecessary-xdg-config-cosmic-rw-access
  - --filesystem=xdg-config/cosmic:rw
  # D-Bus access for COSMIC config daemon (live theme/config updates)
  # The wildcard is needed because the settings daemon creates dynamic config proxy
  # names like com.system76.CosmicSettingsDaemon.Config.com.system76.CosmicTheme.Dark.V1
  - --talk-name=com.system76.CosmicSettingsDaemon
  - --talk-name=com.system76.CosmicSettingsDaemon.*
  # Needed to open the directory the songs are downloaded to
  # xdg portal can only open the top-level dir in the document portal
  - --talk-name=org.freedesktop.FileManager1

modules:
  - name: deno
    buildsystem: simple
    build-commands:
      - install -Dt /app/bin deno
    sources:
      - type: archive
        url: >-
          https://github.com/denoland/deno/releases/download/v2.6.7/deno-x86_64-unknown-linux-gnu.zip
        sha256: c5626c9ee10e87201706fc5e64ed5a44b31527d98c130f164e149e1477c0a87d
        x-checker-data:
          type: json
          url: https://api.github.com/repos/denoland/deno/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | select(.name ==
            "deno-x86_64-unknown-linux-gnu.zip").browser_download_url
        only-arches:
          - x86_64
      - type: archive
        url: >-
          https://github.com/denoland/deno/releases/download/v2.6.7/deno-aarch64-unknown-linux-gnu.zip
        sha256: d2aedfa8c73e258cce78dc80e8d0e764a69d4a09d946d32f0c29eef46592b82f
        x-checker-data:
          type: json
          url: https://api.github.com/repos/denoland/deno/releases/latest
          version-query: .tag_name
          url-query: >-
            .assets[] | select(.name ==
            "deno-aarch64-unknown-linux-gnu.zip").browser_download_url
        only-arches:
          - aarch64
  - name: yt-dlp-ejs
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app yt_dlp_ejs-0.3.2-py3-none-any.whl
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/a4/90/8911146822364666be47f184c4180cec20fcc537a268ef40d1ab077dd25b/yt_dlp_ejs-0.4.0-py3-none-any.whl
        sha256: 19278cff397b243074df46342bb7616c404296aeaff01986b62b4e21823b0b9c
        x-checker-data:
          type: pypi
          name: yt-dlp-ejs
          packagetype: bdist_wheel
  - name: yt-dlp
    buildsystem: simple
    build-commands:
      - pip3 install --no-dependencies --prefix=/app "yt_dlp-2025.12.8-py3-none-any.whl[default]"
    sources:
      - type: file
        url: >-
          https://files.pythonhosted.org/packages/0f/1d/696538eb18a9da3dd4b7772162cb3a6537723a56426a7452b98201c04bfd/yt_dlp-2026.1.29-py3-none-any.whl
        sha256: 08d0a25aead160c4787cbd0d2e82a269c75c8dbcfbfa729ce45ad52a8375fa1d
        x-checker-data:
          type: pypi
          name: yt-dlp
          packagetype: bdist_wheel
  - name: musicfetch
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/musicfetch/cargo
        CARGO_TARGET_DIR: /run/build/musicfetch/target
    build-commands:
      # Build the application with cargo (version is passed via .flatpak-version file)
      - |
        cargo --offline fetch --manifest-path Cargo.toml --verbose
        cargo --offline build --release --verbose
      # Install the binary
      - install -Dm755 target/release/musicfetch_gui -t /app/bin/
      # Install desktop file
      - install -Dm644 resources/net.fhannenheim.musicfetch.desktop -t /app/share/applications/
      # Install icon
      - install -Dm644 resources/icons/hicolor/scalable/apps/net.fhannenheim.musicfetch.svg
        -t /app/share/icons/hicolor/scalable/apps/
      # Install metainfo
      - install -Dm644 resources/net.fhannenheim.musicfetch.metainfo.xml -t /app/share/metainfo/
    sources:
      - type: git
        url: https://codeberg.org/Frieder_Hannenheim/musicfetch-ng.git
        tag: 1.2.1
        commit: 4547faf9012a43af5b2261e4e15711cf09c1697d
      - cargo-sources.json
